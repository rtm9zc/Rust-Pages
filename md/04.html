<!DOCTYPE HTML>
<html lang="en-US" manifest="../manifest.appcache">
    <head prefix="og: http://ogp.me/ns# book: http://ogp.me/ns/book#">
        
        <meta charset="UTF-8">
        <title>Tasks and Communication | Introduction to Rust: From HelloWorld to MapReduce in Four Steps</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="robots" content="index, follow">
        <meta name="author" content="rtm9zc">
        <meta name="description" content="RustLogoRust, in the words of the developers, is a &quot;systems programming language that runs blazingly fast, prevents almost all crashes, and eliminates data races.&quot; These characteristics make it well suited for developing large, concurrent, performance-critical systems that are so prevelant in today&#39;s computing world.">
        <meta name="keywords" content="gitbook,github" >
        <meta name="generator" content="www.gitbook.io">

        
        <link rel="next" href="../md/04/1.html" />
        
        
        <link rel="prev" href="../md/03/5.html" />
        

        <meta property="og:title" content="Tasks and Communication | Introduction to Rust: From HelloWorld to MapReduce in Four Steps">
        <meta property="og:site_name" content="Introduction to Rust: From HelloWorld to MapReduce in Four Steps">
        <meta property="og:type" content="book">
        <meta property="og:locale" content="en_US">

        <meta property="book:author" content="https://github.com/rtm9zc">
        <meta property="book:tag" content="GitBook">

        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    </head>
    <body>
        

        <link rel="stylesheet" href="../gitbook/style.css">
        


        
    <div class="book" data-github="rtm9zc/Rust-Pages" data-level="4" data-basepath=".." data-revision="1402429711148">
    <div class="book-header">
    <!-- Actions Left -->
    
    <a href="https://github.com/rtm9zc/Rust-Pages" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    

    
    <a href="https://github.com/rtm9zc/Rust-Pages/stargazers" target="_blank" class="btn pull-right count-star hidden-xs"><i class="fa fa-star-o"></i> Star (<span>-</span>)</a>
    <a href="https://github.com/rtm9zc/Rust-Pages/watchers" target="_blank" class="btn pull-right count-watch hidden-xs"><i class="fa fa-eye"></i> Watch (<span>-</span>)</a>
    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="../" >Introduction to Rust: From HelloWorld to MapReduce in Four Steps</a>
    </h1>
</div>

    <div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        <li>
            <a href="https://github.com/rtm9zc" target="blank" class="author-link">About the author</a>
        </li>
        

        
        <li>
            <a href="https://github.com/rtm9zc/Rust-Pages/issues" target="blank"class="issues-link">Questions and Issues</a>
        </li>
        

        
        <li>
            <a href="https://github.com/rtm9zc/Rust-Pages/edit/master/md/04.md" target="blank" class="contribute-link">Edit and Contribute</a>
        </li>
        

        

        <li data-level="0" data-path="index.html">
            <a href="../"><i class="fa fa-check"></i> Introduction</a>
        </li>
        
            <li class="chapter " data-level="1" data-path="md/01.html">
                
                <a href="../md/01.html">
                    <i class="fa fa-check"></i> <b>1.</b> Getting Started
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="1.1" data-path="md/01/1.html">
                            
                            <a href="../md/01/1.html">
                                <i class="fa fa-check"></i> <b>1.1.</b> Variables
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.2" data-path="md/01/2.html">
                            
                            <a href="../md/01/2.html">
                                <i class="fa fa-check"></i> <b>1.2.</b> Conditionals
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.3" data-path="md/01/3.html">
                            
                            <a href="../md/01/3.html">
                                <i class="fa fa-check"></i> <b>1.3.</b> Pattern Matching
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.4" data-path="md/01/4.html">
                            
                            <a href="../md/01/4.html">
                                <i class="fa fa-check"></i> <b>1.4.</b> Looping
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.5" data-path="md/01/5.html">
                            
                            <a href="../md/01/5.html">
                                <i class="fa fa-check"></i> <b>1.5.</b> Expressions
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.6" data-path="md/01/6.html">
                            
                            <a href="../md/01/6.html">
                                <i class="fa fa-check"></i> <b>1.6.</b> Functions
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.7" data-path="md/01/7.html">
                            
                            <a href="../md/01/7.html">
                                <i class="fa fa-check"></i> <b>1.7.</b> Program 1: Collatz
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li class="chapter " data-level="2" data-path="md/02.html">
                
                <a href="../md/02.html">
                    <i class="fa fa-check"></i> <b>2.</b> Starting to Corrode: Pointers, Memory, Strings, and I/O
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="2.1" data-path="md/02/1.html">
                            
                            <a href="../md/02/1.html">
                                <i class="fa fa-check"></i> <b>2.1.</b> Memory Management and Pointers
                            </a>
                            
                        </li>
                    
                        <li  data-level="2.2" data-path="md/02/2.html">
                            
                            <a href="../md/02/2.html">
                                <i class="fa fa-check"></i> <b>2.2.</b> Vectors and Strings
                            </a>
                            
                        </li>
                    
                        <li  data-level="2.3" data-path="md/02/3.html">
                            
                            <a href="../md/02/3.html">
                                <i class="fa fa-check"></i> <b>2.3.</b> Error Handling
                            </a>
                            
                        </li>
                    
                        <li  data-level="2.4" data-path="md/02/4.html">
                            
                            <a href="../md/02/4.html">
                                <i class="fa fa-check"></i> <b>2.4.</b> Basic I/O
                            </a>
                            
                        </li>
                    
                        <li  data-level="2.5" data-path="md/02/5.html">
                            
                            <a href="../md/02/5.html">
                                <i class="fa fa-check"></i> <b>2.5.</b> Example: Secret Sharing
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li class="chapter " data-level="3" data-path="md/03.html">
                
                <a href="../md/03.html">
                    <i class="fa fa-check"></i> <b>3.</b> Multi-Purpose Maps: Structures, Traits, and Higher-Order Functions
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="3.1" data-path="md/03/1.html">
                            
                            <a href="../md/03/1.html">
                                <i class="fa fa-check"></i> <b>3.1.</b> Structures
                            </a>
                            
                        </li>
                    
                        <li  data-level="3.2" data-path="md/03/2.html">
                            
                            <a href="../md/03/2.html">
                                <i class="fa fa-check"></i> <b>3.2.</b> Traits
                            </a>
                            
                        </li>
                    
                        <li  data-level="3.3" data-path="md/03/3.html">
                            
                            <a href="../md/03/3.html">
                                <i class="fa fa-check"></i> <b>3.3.</b> Generics
                            </a>
                            
                        </li>
                    
                        <li  data-level="3.4" data-path="md/03/4.html">
                            
                            <a href="../md/03/4.html">
                                <i class="fa fa-check"></i> <b>3.4.</b> Higher-Order Functions
                            </a>
                            
                        </li>
                    
                        <li  data-level="3.5" data-path="md/03/5.html">
                            
                            <a href="../md/03/5.html">
                                <i class="fa fa-check"></i> <b>3.5.</b> Example: Mapping a List
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li class="chapter " data-level="4" data-path="md/04.html">
                
                <a href="../md/04.html">
                    <i class="fa fa-check"></i> <b>4.</b> Tasks and Communication
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="4.1" data-path="md/04/1.html">
                            
                            <a href="../md/04/1.html">
                                <i class="fa fa-check"></i> <b>4.1.</b> Task Properties
                            </a>
                            
                        </li>
                    
                        <li  data-level="4.2" data-path="md/04/2.html">
                            
                            <a href="../md/04/2.html">
                                <i class="fa fa-check"></i> <b>4.2.</b> Example: Multi-Tasking Map
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li class="chapter " data-level="5" data-path="md/05.html">
                
                <a href="../md/05.html">
                    <i class="fa fa-check"></i> <b>5.</b> Concurrency Across Tasks: Arcs and Mutexes
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="5.1" data-path="md/05/1.html">
                            
                            <a href="../md/05/1.html">
                                <i class="fa fa-check"></i> <b>5.1.</b> The Arc Module
                            </a>
                            
                        </li>
                    
                        <li  data-level="5.2" data-path="md/05/2.html">
                            
                            <a href="../md/05/2.html">
                                <i class="fa fa-check"></i> <b>5.2.</b> Using a Mutex
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li class="chapter " data-level="6" data-path="md/06.html">
                
                <a href="../md/06.html">
                    <i class="fa fa-check"></i> <b>6.</b> MapReduce in Rust
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="6.1" data-path="md/06/1.html">
                            
                            <a href="../md/06/1.html">
                                <i class="fa fa-check"></i> <b>6.1.</b> Using mapreduce
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        

        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 75%;min-width: 71.42857142857143%;"></div>
    </div>
    <div class="chapters">
    
        <a href="../index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="../md/01.html" title="Getting Started" class="chapter done new-chapter" data-progress="1" style="left: 3.5714285714285716%;"></a>
    
        <a href="../md/01/1.html" title="Variables" class="chapter done " data-progress="1.1" style="left: 7.142857142857143%;"></a>
    
        <a href="../md/01/2.html" title="Conditionals" class="chapter done " data-progress="1.2" style="left: 10.714285714285714%;"></a>
    
        <a href="../md/01/3.html" title="Pattern Matching" class="chapter done " data-progress="1.3" style="left: 14.285714285714286%;"></a>
    
        <a href="../md/01/4.html" title="Looping" class="chapter done " data-progress="1.4" style="left: 17.857142857142858%;"></a>
    
        <a href="../md/01/5.html" title="Expressions" class="chapter done " data-progress="1.5" style="left: 21.428571428571427%;"></a>
    
        <a href="../md/01/6.html" title="Functions" class="chapter done " data-progress="1.6" style="left: 25%;"></a>
    
        <a href="../md/01/7.html" title="Program 1: Collatz" class="chapter done " data-progress="1.7" style="left: 28.571428571428573%;"></a>
    
        <a href="../md/02.html" title="Starting to Corrode: Pointers, Memory, Strings, and I/O" class="chapter done new-chapter" data-progress="2" style="left: 32.142857142857146%;"></a>
    
        <a href="../md/02/1.html" title="Memory Management and Pointers" class="chapter done " data-progress="2.1" style="left: 35.714285714285715%;"></a>
    
        <a href="../md/02/2.html" title="Vectors and Strings" class="chapter done " data-progress="2.2" style="left: 39.285714285714285%;"></a>
    
        <a href="../md/02/3.html" title="Error Handling" class="chapter done " data-progress="2.3" style="left: 42.857142857142854%;"></a>
    
        <a href="../md/02/4.html" title="Basic I/O" class="chapter done " data-progress="2.4" style="left: 46.42857142857143%;"></a>
    
        <a href="../md/02/5.html" title="Example: Secret Sharing" class="chapter done " data-progress="2.5" style="left: 50%;"></a>
    
        <a href="../md/03.html" title="Multi-Purpose Maps: Structures, Traits, and Higher-Order Functions" class="chapter done new-chapter" data-progress="3" style="left: 53.57142857142857%;"></a>
    
        <a href="../md/03/1.html" title="Structures" class="chapter done " data-progress="3.1" style="left: 57.142857142857146%;"></a>
    
        <a href="../md/03/2.html" title="Traits" class="chapter done " data-progress="3.2" style="left: 60.714285714285715%;"></a>
    
        <a href="../md/03/3.html" title="Generics" class="chapter done " data-progress="3.3" style="left: 64.28571428571429%;"></a>
    
        <a href="../md/03/4.html" title="Higher-Order Functions" class="chapter done " data-progress="3.4" style="left: 67.85714285714286%;"></a>
    
        <a href="../md/03/5.html" title="Example: Mapping a List" class="chapter done " data-progress="3.5" style="left: 71.42857142857143%;"></a>
    
        <a href="../md/04.html" title="Tasks and Communication" class="chapter done new-chapter" data-progress="4" style="left: 75%;"></a>
    
        <a href="../md/04/1.html" title="Task Properties" class="chapter  " data-progress="4.1" style="left: 78.57142857142857%;"></a>
    
        <a href="../md/04/2.html" title="Example: Multi-Tasking Map" class="chapter  " data-progress="4.2" style="left: 82.14285714285714%;"></a>
    
        <a href="../md/05.html" title="Concurrency Across Tasks: Arcs and Mutexes" class="chapter  new-chapter" data-progress="5" style="left: 85.71428571428571%;"></a>
    
        <a href="../md/05/1.html" title="The Arc Module" class="chapter  " data-progress="5.1" style="left: 89.28571428571429%;"></a>
    
        <a href="../md/05/2.html" title="Using a Mutex" class="chapter  " data-progress="5.2" style="left: 92.85714285714286%;"></a>
    
        <a href="../md/06.html" title="MapReduce in Rust" class="chapter  new-chapter" data-progress="6" style="left: 96.42857142857143%;"></a>
    
        <a href="../md/06/1.html" title="Using mapreduce" class="chapter  " data-progress="6.1" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_28">
                    
                        <h1 id="tasks-and-communication">Tasks and Communication</h1>
<h2 id="task-properties">Task Properties</h2>
<p>Rust is described by the developers as a language that concentrates on, amoung other things, safety and concurrency. In order to ensure safe, cocurrent computation, Rust makes use of <em>tasks</em>.</p>
<p>A Rust <em>task</em> is an abstraction that has its own memory space and registers, like a process, but doesn&#39;t have a processes&#39; associated operating system cost. Tasks split computation like threads, however do not share memory, thus preventing implicit data races and other perplexing bugs that occur when multiple threads access and modify the same data.</p>
<h3 id="spawning-a-task">Spawning a Task</h3>
<p>Tasks are created using the <code>spawn(fn())</code> function, which creates a new task and executes the input function, <code>fn()</code> in that task.  After the function completes, the task is terminated. </p>
<p>Another way to do this is with the <code>do</code> construct.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">do</span> expr { block }
</code></pre>
<p>The above block is syntactic sugar for </p>
<pre><code class="lang-rust">expr(proc() { block })
</code></pre>
<p>Thus, applying this to Rust task spawning, code, the following two blocks will spawn a task in a functionally identical manner.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">do</span> spawn { a; }
</code></pre>
<pre><code class="lang-rust">spawn(proc() { a; })
</code></pre>
<p><b>Note:</b> there are <a href="https://github.com/mozilla/rust/issues/10815">plans to remove 
do</a> from upcoming versions of Rust, so we don&#39;t recommend using it, but since you will see it in lots of example code still describe it here.</p>
<p>Here&#39;s an example program that spawns tasks:</p>
<pre><code class="lang-rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">count</span>(</span>m: &amp;<span class="hljs-keyword">str</span>, n: <span class="hljs-keyword">int</span>) {
    <span class="hljs-keyword">for</span> i in range(<span class="hljs-number">1</span>, n) {
        println!(<span class="hljs-string">"{:s}{:d}"</span>, m, i); 
    }
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span>(</span>) {
    spawn(proc() { count(<span class="hljs-string">"A"</span>, <span class="hljs-number">1000</span>); });
    spawn(proc() { count(<span class="hljs-string">"B"</span>, <span class="hljs-number">1000</span>); });
    spawn(proc() { count(<span class="hljs-string">"C"</span>, <span class="hljs-number">1000</span>); });
}
</code></pre>
<p>If you try running this, you will see something like:</p>
<blockquote>
<p>B1
C1
A1
C2
B2
A2
B3
...</p>
</blockquote>
<p>where the events from the three tasks are interleaved.  (Try changing the <code>println!</code> to a <code>print!</code> and see how that impacts the amount of interleaving you see.)</p>
<h3 id="task-communication">Task Communication</h3>
<p>Tasks do not share memory, and each task has its own memory space. The tasks all run in the same process, though, the memory isloation is provided by the Rust compiler and run-time, not by the operating system with hardware support as is done for an OS process.</p>
<p>Spawning a task and then trying to access mutable variables from outside the scope of the task itself will result in a compiler error.  For example, the following code is okay since is okay since <code>n</code> is declared as immutable.</p>
<pre><code class="lang-rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span>(</span>) {
    <span class="hljs-keyword">let</span> n = <span class="hljs-number">10</span>;
    spawn(proc() { count(<span class="hljs-string">"A"</span>, n); });
    spawn(proc() { count(<span class="hljs-string">"B"</span>, n); });
    spawn(proc() { count(<span class="hljs-string">"C"</span>, n); });
}
</code></pre>
<p>But if we change the variable <code>n</code> to be mutable, the compiler will disallow the code with this error: </p>
<pre><code class="lang-rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span>(</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> n = <span class="hljs-number">10</span>;
    spawn(proc() { count(<span class="hljs-string">"A"</span>, n); });
    ...
</code></pre>
<pre><code>sharing.rs:9:31: 9:32 <span style="color:red;">error: mutable variables cannot be implicitly captured</span>
sharing.rs:9     spawn(proc() { count("A", n); });
</code></pre>

<p>The problem here is that mutable data cannot be shared across tasks, since this could lead to dangerous and difficult to find bugs.  Instead, we need to make all communication between tasks explicit.</p>
<h4 id="ports-and-channels">Ports and Channels</h4>
<p>Cross-task communication is accomplished through the use of <code>Port&lt;T&gt;</code> and <code>Chan&lt;T&gt;</code> objects. These can be thought of as a link between a spawned task and its parent (the task which spawned it).</p>
<p>A Port/Chan pair is created as a tuple, as demonstrated in the code below. The type of <code>&lt;T&gt;</code> is unrestricted, however the <code>Port</code> and <code>Chan</code> must have matching types.</p>
<p>The transfer of values between tasks is accomplished with the <code>Chan.send(T)</code> function, which puts a value into the <code>(Port&lt;T&gt;, Chan&lt;T&gt;)</code> pair, and the <code>Port.recv()</code> function, which returns the value that had been sent by the <code>Chan</code>. </p>
<p>The following spawns a very simple task to call a <code>plustwo</code> function, and then send the result back to the parent thread.</p>
<pre><code class="lang-rust">   <span class="hljs-keyword">let</span> (port, chan): (Port&lt;<span class="hljs-keyword">int</span>&gt;, Chan&lt;<span class="hljs-keyword">int</span>&gt;) = Chan::new();
   spawn(proc() {
        <span class="hljs-keyword">let</span> x = <span class="hljs-number">10</span>;
        chan.send(plustwo(x));
    });
    <span class="hljs-keyword">let</span> new_x = port.recv(); <span class="hljs-comment">// new_x == 12</span>
</code></pre>
<p>A <code>(Port&lt;T&gt;, Chan&lt;T&gt;)</code> pair can only be sent to from a single task. Once <code>Chan.send(T)</code> has been called from a specific task, that task owns the channel. Trying to call <code>Chan.send(T)</code> from multiple tasks will result in a compile time error. Thus, to send objects back and forth between tasks, two different channels are necessary. </p>
<p>The following example does the same as the previous, but receives the value for <code>plustwo(x)</code> from the parent task, instead of creating it within the spawned task.</p>
<pre><code class="lang-rust">    <span class="hljs-keyword">let</span> (port1, chan1): (Port&lt;<span class="hljs-keyword">int</span>&gt;, Chan&lt;<span class="hljs-keyword">int</span>&gt;) = Chan::new();
    <span class="hljs-keyword">let</span> (port2, chan2): (Port&lt;<span class="hljs-keyword">int</span>&gt;, Chan&lt;<span class="hljs-keyword">int</span>&gt;) = Chan::new();
    <span class="hljs-keyword">do</span> spawn {
        <span class="hljs-keyword">let</span> x = port2.recv();
        chan1.send(plustwo(x));
    }
    chan2.send(<span class="hljs-number">10</span>);
    <span class="hljs-keyword">let</span> new_x = port1.recv(); <span class="hljs-comment">//new_x == 12</span>
</code></pre>
<p>Recieving is synchronous.  So, once <code>Port.recv()</code> has been called, the task that called it will not continue until a value is sent.</p>
<p>This can lead to deadlocking programs.  For example, if a <code>Port.recv()</code> is waiting on a send from another task, but that other task is waiting to receive something from the original task, neither task can make progress.</p>
<h2 id="example-multi-tasking-map">Example: Multi-Tasking Map</h2>
<p>To put everything together, we modify the mapping code from the previous tutorial section to update each element in a separate task.  If the computation needed to produce each new value is expensive, this will potentially divide the mapping time by the number of cores available (with some overhead for spawning the tasks and the communication channels).</p>
<p>Try running the code below, and see if you can figure out why the order of the statements in the mapr function matters.</p>
<pre><code class="lang-rust"><span class="hljs-preprocessor">#[deriving(Clone)]</span>
<span class="hljs-preprocessor">#[deriving(ToStr)]</span>
<span class="hljs-keyword">type</span> <span class="hljs-title">LinkedList</span> = Option&lt;~Node&gt;;

<span class="hljs-preprocessor">#[deriving(Clone)]</span>
<span class="hljs-keyword">struct</span> Node {
   val: <span class="hljs-keyword">int</span>,
   tail: LinkedList
}

<span class="hljs-keyword">trait</span> <span class="hljs-title">Length</span> {
   <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">length</span>(</span>&amp;<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-keyword">int</span>;
}

<span class="hljs-preprocessor">#[allow(dead_code)]</span> 
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">length</span>(</span>p: LinkedList) -&gt; <span class="hljs-keyword">int</span> {
   <span class="hljs-keyword">match</span> p {
      None =&gt; { <span class="hljs-number">0</span> }
      Some(node) =&gt; { <span class="hljs-number">1</span> + length(node.tail) }
   }
}

<span class="hljs-keyword">impl</span> Length <span class="hljs-keyword">for</span> LinkedList {
   <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">length</span>(</span>&amp;<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-keyword">int</span> {
      <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span> {
        &amp;Some(<span class="hljs-keyword">ref</span> node) =&gt; { <span class="hljs-number">1</span> + node.tail.length() }
        &amp;None =&gt; <span class="hljs-number">0</span>
      }
   }
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">construct_list</span>(</span>n: <span class="hljs-keyword">int</span>, x: <span class="hljs-keyword">int</span>) -&gt; LinkedList {
    <span class="hljs-keyword">match</span> n {
        <span class="hljs-number">0</span> =&gt; { None }
        <span class="hljs-number">_</span> =&gt; { Some(~Node{val: x, tail: construct_list(n - <span class="hljs-number">1</span>, x + <span class="hljs-number">1</span>)}) }
    }
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">print_list</span>(</span>p: LinkedList) -&gt; ~<span class="hljs-keyword">str</span> {
    <span class="hljs-keyword">match</span> p {
        None =&gt; { ~<span class="hljs-string">""</span> }
        Some(node) =&gt; { node.val.to_str() + <span class="hljs-string">", "</span> + print_list(node.tail) }
    }
}

<span class="hljs-keyword">trait</span> <span class="hljs-title">Map</span> {
   <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">mapr</span>(</span>&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, <span class="hljs-function"><span class="hljs-keyword">fn</span>(</span><span class="hljs-keyword">int</span>) -&gt; <span class="hljs-keyword">int</span>);
}


<span class="hljs-keyword">impl</span> Map <span class="hljs-keyword">for</span> LinkedList {
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">mapr</span>(</span>&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, f: <span class="hljs-function"><span class="hljs-keyword">fn</span>(</span><span class="hljs-keyword">int</span>) -&gt; <span class="hljs-keyword">int</span>) {
         <span class="hljs-keyword">match</span>(*<span class="hljs-keyword">self</span>) {
            None =&gt; { }
            Some(<span class="hljs-keyword">ref</span> <span class="hljs-keyword">mut</span> current) =&gt; { 
               <span class="hljs-keyword">let</span> (port, chan) : (Port&lt;<span class="hljs-keyword">int</span>&gt;, Chan&lt;<span class="hljs-keyword">int</span>&gt;) = Chan::new();
               <span class="hljs-keyword">let</span> val = current.val; <span class="hljs-comment">// Can't use current inside task!</span>
               spawn(proc() { chan.send(f(val)); });
               current.tail.mapr(f); <span class="hljs-comment">// Make sure to do this first, so we're not waiting for recv!</span>
               current.val = port.recv();
            }
        } 
    } 
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">expensive_inc</span>(</span>n: <span class="hljs-keyword">int</span>) -&gt; <span class="hljs-keyword">int</span> { 
   <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> a = <span class="hljs-number">1</span>;
   println!(<span class="hljs-string">"starting inc: {:d}"</span>, n);
   <span class="hljs-keyword">for</span> <span class="hljs-number">_</span> in range(<span class="hljs-number">0</span>, <span class="hljs-number">10000</span>) {
        <span class="hljs-keyword">for</span> <span class="hljs-number">_</span> in range(<span class="hljs-number">0</span>, <span class="hljs-number">1000000</span>) {
           a = a + <span class="hljs-number">1</span>;
        }
   }

   println!(<span class="hljs-string">"finished inc: {:d} ({:d})"</span>, n, a);
   n + <span class="hljs-number">1</span> 
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span>(</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> l10 : LinkedList = construct_list(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>);
    l10.mapr(expensive_inc);
    println!(<span class="hljs-string">"List: {:s}"</span>, print_list(l10.clone()));
}
</code></pre>

                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="../md/03/5.html" class="navigation navigation-prev " aria-label="Previous page: Example: Mapping a List"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../md/04/1.html" class="navigation navigation-next " aria-label="Next page: Task Properties"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-javascript.js"></script>
        <script src="../gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
        <script src="../gitbook/app.js"></script>
        

    
    <script src="../gitbook/plugins/gitbook-plugin-mixpanel/plugin.js"></script>
    

    
    <script src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

    </body>
</html>
